{% extends "base.html" %}

{% block title %}å‘é€äº¤æ˜“ - æ¯”ç‰¹å¸ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-paper-plane"></i> å‘é€äº¤æ˜“
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit"></i> åˆ›å»ºæ–°äº¤æ˜“
                </h5>
            </div>
            <div class="card-body">
                <form id="transactionForm">
                    <div class="mb-3">
                        <label for="fromWallet" class="form-label">å‘é€æ–¹é’±åŒ…</label>
                        <select class="form-select" id="fromWallet" required>
                            <option value="">é€‰æ‹©é’±åŒ…</option>
                            {% for wallet in wallets %}
                            <option value="{{ wallet.name }}" data-balance="{{ wallet.balance }}">
                                {{ wallet.name }} ({{ wallet.address[:16] }}...) - {{ "%.4f"|format(wallet.balance) }}
                                BTC
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">é€‰æ‹©è¦å‘é€äº¤æ˜“çš„é’±åŒ…</div>
                    </div>

                    <div class="mb-3">
                        <label for="toWallet" class="form-label">æ¥æ”¶æ–¹åœ°å€</label>
                        <select class="form-select" id="toWallet" required>
                            <option value="">é€‰æ‹©æ¥æ”¶æ–¹</option>
                            {% for wallet in wallets %}
                            <option value="{{ wallet.address }}" data-name="{{ wallet.name }}">
                                {{ wallet.name }} ({{ wallet.address[:16] }}...)
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">é€‰æ‹©ç°æœ‰é’±åŒ…ä½œä¸ºæ¥æ”¶æ–¹</div>
                    </div>

                    <div class="mb-3">
                        <label for="amount" class="form-label">é‡‘é¢</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="amount" step="0.0001" min="0.0001" required
                                placeholder="0.0000">
                            <span class="input-group-text">BTC</span>
                        </div>
                        <div class="form-text">
                            äº¤æ˜“æ‰‹ç»­è´¹: <span class="text-muted">0.01 BTC</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">äº¤æ˜“æ‘˜è¦</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">å‘é€é‡‘é¢:</small><br>
                                        <span id="sendAmount">0.0000 BTC</span>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">äº¤æ˜“è´¹ç”¨:</small><br>
                                        <span>0.01 BTC</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">æ€»è®¡:</small><br>
                                        <strong id="totalAmount">0.01 BTC</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">ä½™é¢:</small><br>
                                        <span id="walletBalance">0.0000 BTC</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane"></i> å‘é€äº¤æ˜“
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                            <i class="fas fa-times"></i> æ¸…ç©ºè¡¨å•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i> äº¤æ˜“è¯´æ˜
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6><i class="fas fa-clock"></i> å¤„ç†æ—¶é—´</h6>
                    <p class="text-muted small">
                        äº¤æ˜“å°†è¢«æ·»åŠ åˆ°å¾…å¤„ç†æ± ä¸­ï¼Œç­‰å¾…çŸ¿å·¥æ‰“åŒ…ç¡®è®¤ã€‚
                    </p>
                </div>

                <div class="mb-3">
                    <h6><i class="fas fa-coins"></i> äº¤æ˜“è´¹ç”¨</h6>
                    <p class="text-muted small">
                        é»˜è®¤äº¤æ˜“è´¹ç”¨ä¸º 0.01 BTCï¼Œç”¨äºæ¿€åŠ±çŸ¿å·¥å¤„ç†äº¤æ˜“ã€‚
                    </p>
                </div>

                <div class="mb-3">
                    <h6><i class="fas fa-shield-alt"></i> å®‰å…¨æç¤º</h6>
                    <p class="text-muted small">
                        è¯·ä»”ç»†æ ¸å¯¹æ¥æ”¶æ–¹åœ°å€ï¼Œäº¤æ˜“ä¸€æ—¦å‘é€æ— æ³•æ’¤å›ã€‚
                    </p>
                </div>

                <div class="mb-3">
                    <h6><i class="fas fa-check-circle"></i> äº¤æ˜“çŠ¶æ€</h6>
                    <p class="text-muted small">
                        äº¤æ˜“å‘é€åå¯åœ¨åŒºå—é“¾æµè§ˆå™¨ä¸­æŸ¥çœ‹ç¡®è®¤çŠ¶æ€ã€‚
                    </p>
                </div>
            </div>
        </div>

        {% if wallets %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-wallet"></i> æˆ‘çš„é’±åŒ…
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for wallet in wallets %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ wallet.name }}</strong><br>
                            <small class="text-muted">{{ wallet.address[:16] }}...</small>
                        </div>
                        <span class="badge bg-primary">{{ "%.4f"|format(wallet.balance) }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const TRANSACTION_FEE = 0.01;

    // è¡¨å•æäº¤å¤„ç†
    document.getElementById('transactionForm').addEventListener('submit', function (e) {
        e.preventDefault();
        sendTransaction();
    });

    // é‡‘é¢è¾“å…¥å¤„ç†
    document.getElementById('amount').addEventListener('input', updateSummary);
    document.getElementById('fromWallet').addEventListener('change', function () {
        updateSummary();
        updateBalance();
    });

    // æ¥æ”¶æ–¹åœ°å€é€‰æ‹©å¤„ç†ï¼ˆå·²ç§»é™¤è‡ªå®šä¹‰åœ°å€åŠŸèƒ½ï¼‰

    function updateSummary() {
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const total = amount + TRANSACTION_FEE;

        document.getElementById('sendAmount').textContent = amount.toFixed(4) + ' BTC';
        document.getElementById('totalAmount').textContent = total.toFixed(4) + ' BTC';
    }

    function updateBalance() {
        const select = document.getElementById('fromWallet');
        const selectedOption = select.options[select.selectedIndex];

        if (selectedOption && selectedOption.dataset.balance) {
            const balance = parseFloat(selectedOption.dataset.balance);
            document.getElementById('walletBalance').textContent = balance.toFixed(4) + ' BTC';
        } else {
            document.getElementById('walletBalance').textContent = '0.0000 BTC';
        }
    }

    function updateWalletBalance() {
        // é‡æ–°è·å–é’±åŒ…ä½™é¢ä¿¡æ¯
        const fromWallet = document.getElementById('fromWallet').value;
        if (!fromWallet) return;

        $.ajax({
            url: '/api/wallet_balance',
            method: 'GET',
            data: { wallet_name: fromWallet },
            success: function (response) {
                if (response.success) {
                    // æ›´æ–°ä¸‹æ‹‰é€‰é¡¹ä¸­çš„ä½™é¢æ•°æ®
                    const select = document.getElementById('fromWallet');
                    const selectedOption = select.options[select.selectedIndex];
                    if (selectedOption) {
                        selectedOption.dataset.balance = response.balance;
                    }
                    // æ›´æ–°æ˜¾ç¤º
                    updateBalance();
                }
            },
            error: function () {
                // å¦‚æœè·å–å¤±è´¥ï¼Œä¿æŒåŸæœ‰æ˜¾ç¤º
                console.log('è·å–é’±åŒ…ä½™é¢å¤±è´¥');
            }
        });
    }

    function sendTransaction() {
        const fromWallet = document.getElementById('fromWallet').value;
        const toWallet = document.getElementById('toWallet').value;
        const amount = parseFloat(document.getElementById('amount').value);

        // æ¥æ”¶æ–¹åœ°å€å°±æ˜¯é€‰æ‹©çš„é’±åŒ…åœ°å€
        const toAddress = toWallet;

        if (!fromWallet || !toAddress || !amount) {
            showAlert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'danger');
            return;
        }

        if (amount <= 0) {
            showAlert('é‡‘é¢å¿…é¡»å¤§äº 0', 'danger');
            return;
        }

        // æ£€æŸ¥æ˜¯å¦å‘é€ç»™è‡ªå·±
        const toSelect = document.getElementById('toWallet');
        const toOption = toSelect.options[toSelect.selectedIndex];
        if (toOption && toOption.dataset.name === fromWallet) {
            showAlert('ä¸èƒ½å‘é€äº¤æ˜“ç»™è‡ªå·±', 'danger');
            return;
        }

        // æ£€æŸ¥ä½™é¢
        const fromSelect = document.getElementById('fromWallet');
        const fromOption = fromSelect.options[fromSelect.selectedIndex];
        const balance = parseFloat(fromOption.dataset.balance);

        if (balance < amount + TRANSACTION_FEE) {
            showAlert('ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢: ' + balance.toFixed(4) + ' BTC', 'danger');
            return;
        }

        // ç¡®è®¤äº¤æ˜“
        let toDisplayText = toAddress;
        if (toOption && toOption.dataset.name) {
            toDisplayText = toOption.dataset.name + ' (' + toAddress.substring(0, 16) + '...)';
        }

        if (!confirm(`ç¡®å®šè¦å‘é€ ${amount.toFixed(4)} BTC åˆ° ${toDisplayText}å—ï¼Ÿ\n\næ€»è´¹ç”¨: ${(amount + TRANSACTION_FEE).toFixed(4)} BTC`)) {
            return;
        }

        // å‘é€äº¤æ˜“
        const submitButton = document.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‘é€ä¸­...';
        submitButton.disabled = true;

        $.ajax({
            url: '/api/send_transaction',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                from_wallet: fromWallet,
                to_address: toAddress,
                amount: amount
            }),
            success: function (response) {
                // ç«‹å³æ¢å¤æŒ‰é’®çŠ¶æ€
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;

                if (response.success) {
                    showAlert('äº¤æ˜“å‘é€æˆåŠŸï¼\näº¤æ˜“ID: ' + response.transaction_id, 'success');
                    clearForm();
                    // æ›´æ–°é’±åŒ…ä½™é¢æ˜¾ç¤º
                    updateWalletBalance();
                } else {
                    let errorMessage = 'äº¤æ˜“å‘é€å¤±è´¥ï¼š' + response.error;
                    if (response.error === 'åˆ›å»ºäº¤æ˜“å¤±è´¥') {
                        errorMessage += '\n\nğŸ’¡ å¯èƒ½åŸå› ï¼šUTXOå·²è¢«é”å®š\nå»ºè®®ï¼šè¯·å…ˆæŒ–çŸ¿æ‰“åŒ…å¾…å¤„ç†äº¤æ˜“ï¼Œç„¶åå†å‘é€æ–°äº¤æ˜“';
                    }
                    showAlert(errorMessage, 'danger');
                }
            },
            error: function (xhr) {
                // ç«‹å³æ¢å¤æŒ‰é’®çŠ¶æ€
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;

                const response = xhr.responseJSON;
                let errorMessage = 'äº¤æ˜“å‘é€å¤±è´¥ï¼š' + (response ? response.error : 'æœªçŸ¥é”™è¯¯');
                if (response && response.error === 'åˆ›å»ºäº¤æ˜“å¤±è´¥') {
                    errorMessage += '\n\nğŸ’¡ å¯èƒ½åŸå› ï¼šUTXOå·²è¢«é”å®š\nå»ºè®®ï¼šè¯·å…ˆæŒ–çŸ¿æ‰“åŒ…å¾…å¤„ç†äº¤æ˜“ï¼Œç„¶åå†å‘é€æ–°äº¤æ˜“';
                }
                showAlert(errorMessage, 'danger');
            }
        });
    }

    function clearForm() {
        document.getElementById('transactionForm').reset();
        document.getElementById('customAddressDiv').style.display = 'none';
        document.getElementById('customAddress').required = false;
        updateSummary();
        updateBalance();
    }

    function showAlert(message, type) {
        // è½¬æ¢ä¸ºæ–°çš„é€šçŸ¥ç±»å‹
        const notificationType = type === 'danger' ? 'danger' : type;
        showNotification(message.replace(/\n/g, '<br>'), notificationType, 8000);
    }

    // åˆå§‹åŒ–
    updateSummary();
    updateBalance();

    // å¤„ç†URLå‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const fromWallet = urlParams.get('from');
    if (fromWallet) {
        document.getElementById('fromWallet').value = fromWallet;
        updateBalance();
    }
</script>
{% endblock %}
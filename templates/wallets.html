{% extends "base.html" %}

{% block title %}é’±åŒ…ç®¡ç† - æ¯”ç‰¹å¸ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-wallet"></i> é’±åŒ…ç®¡ç†
        </h1>
    </div>
</div>

<!-- æ“ä½œæŒ‰é’® -->
<div class="row mb-4">
    <div class="col-md-12">
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createWalletModal">
            <i class="fas fa-plus"></i> åˆ›å»ºæ–°é’±åŒ…
        </button>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importWalletModal">
            <i class="fas fa-download"></i> å¯¼å…¥é’±åŒ…
        </button>
    </div>
</div>

<!-- è·èƒœè€…æç¤º -->
{% if highlight_wallet %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-trophy"></i>
    <strong>ğŸ‰ æ­å–œï¼</strong> é’±åŒ… <strong>{{ highlight_wallet }}</strong> åœ¨æŒ–çŸ¿ç«äº‰ä¸­è·èƒœï¼Œè·å¾—äº†åŒºå—å¥–åŠ±ï¼
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- é’±åŒ…åˆ—è¡¨ -->
{% if wallets %}
<div class="row">
    {% for wallet_data in wallets %}
    <div class="col-md-6 mb-4">
        <div class="card{% if wallet_data.is_winner %} winner-wallet{% endif %}">
            <div class="card-header{% if wallet_data.is_winner %} bg-success text-white{% endif %}">
                <h5 class="mb-0">
                    <i class="fas fa-wallet"></i> {{ wallet_data.name }}
                    {% if wallet_data.is_winner %}
                    <i class="fas fa-crown text-warning ms-2" title="æŒ–çŸ¿è·èƒœè€…"></i>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <p class="mb-2">
                            <strong>åœ°å€:</strong>
                            <code class="text-primary ms-2"
                                style="word-break: break-all; font-size: 0.875rem;">{{ wallet_data.address }}</code>
                        </p>
                        <p class="mb-3">
                            <strong>ä½™é¢:</strong>
                            <span class="badge bg-success fs-6 ms-3">{{ "%.4f"|format(wallet_data.balance) }} BTC</span>
                        </p>
                        <div>
                            <a href="{{ url_for('wallet_detail', wallet_name=wallet_data.name) }}"
                                class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> æŸ¥çœ‹è¯¦æƒ…
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="fas fa-wallet fa-4x text-muted mb-3"></i>
        <h4 class="text-muted">è¿˜æ²¡æœ‰é’±åŒ…</h4>
        <p class="text-muted">åˆ›å»ºæˆ–å¯¼å…¥ä¸€ä¸ªé’±åŒ…æ¥å¼€å§‹ä½¿ç”¨</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createWalletModal">
            <i class="fas fa-plus"></i> åˆ›å»ºæ–°é’±åŒ…
        </button>
    </div>
</div>
{% endif %}

<!-- åˆ›å»ºé’±åŒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="createWalletModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> åˆ›å»ºæ–°é’±åŒ…
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createWalletForm">
                    <div class="mb-3">
                        <label for="walletName" class="form-label">é’±åŒ…åç§°</label>
                        <input type="text" class="form-control" id="walletName" required>
                        <div class="form-text">ä¸ºæ‚¨çš„é’±åŒ…é€‰æ‹©ä¸€ä¸ªå”¯ä¸€çš„åç§°</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="createWallet()">åˆ›å»ºé’±åŒ…</button>
            </div>
        </div>
    </div>
</div>

<!-- å¯¼å…¥é’±åŒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="importWalletModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-download"></i> å¯¼å…¥é’±åŒ…
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importWalletForm">
                    <div class="mb-3">
                        <label for="importWalletName" class="form-label">é’±åŒ…åç§°</label>
                        <input type="text" class="form-control" id="importWalletName" required>
                    </div>
                    <div class="mb-3">
                        <label for="privateKey" class="form-label">ç§é’¥</label>
                        <textarea class="form-control" id="privateKey" rows="3" required
                            placeholder="è¾“å…¥ç§é’¥ï¼ˆWIFæ ¼å¼æˆ–16è¿›åˆ¶ï¼‰"></textarea>
                        <div class="form-text">è¯·è¾“å…¥æœ‰æ•ˆçš„ç§é’¥æ¥å¯¼å…¥é’±åŒ…</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="importWallet()">å¯¼å…¥é’±åŒ…</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function createWallet() {
        const name = document.getElementById('walletName').value;

        if (!name) {
            alert('è¯·è¾“å…¥é’±åŒ…åç§°');
            return;
        }

        $.ajax({
            url: '/api/create_wallet',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: name }),
            success: function (response) {
                if (response.success) {
                    alert('é’±åŒ…åˆ›å»ºæˆåŠŸï¼');
                    location.reload();
                } else {
                    alert('åˆ›å»ºå¤±è´¥ï¼š' + response.error);
                }
            },
            error: function (xhr) {
                const response = xhr.responseJSON;
                alert('åˆ›å»ºå¤±è´¥ï¼š' + (response ? response.error : 'æœªçŸ¥é”™è¯¯'));
            }
        });
    }

    function importWallet() {
        const name = document.getElementById('importWalletName').value;
        const privateKey = document.getElementById('privateKey').value;

        if (!name || !privateKey) {
            alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
            return;
        }

        $.ajax({
            url: '/api/import_wallet',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: name, private_key: privateKey }),
            success: function (response) {
                if (response.success) {
                    alert('é’±åŒ…å¯¼å…¥æˆåŠŸï¼');
                    location.reload();
                } else {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + response.error);
                }
            },
            error: function (xhr) {
                const response = xhr.responseJSON;
                alert('å¯¼å…¥å¤±è´¥ï¼š' + (response ? response.error : 'æœªçŸ¥é”™è¯¯'));
            }
        });
    }

    function exportWallet(walletName) {
        if (confirm('ç¡®å®šè¦å¯¼å‡ºç§é’¥å—ï¼Ÿè¯·å¦¥å–„ä¿ç®¡ç§é’¥ï¼Œä¸è¦æ³„éœ²ç»™ä»–äººï¼')) {
            // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯APIè·å–ç§é’¥
            alert('å¯¼å‡ºåŠŸèƒ½æš‚æœªå®ç°ï¼Œè¯·åœ¨åç«¯æ·»åŠ ç›¸åº”API');
        }
    }

    function copyAddress(address) {
        copyToClipboard(address, 'åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }

    // è·èƒœè€…é’±åŒ…åŠ¨ç”»æ•ˆæœ
    {% if highlight_wallet %}
    $(document).ready(function () {
        // ä¸ºè·èƒœè€…é’±åŒ…æ·»åŠ é—ªçƒåŠ¨ç”»
        $('.winner-wallet').addClass('animate__animated animate__pulse');

        // 5ç§’åç§»é™¤åŠ¨ç”»
        setTimeout(function () {
            $('.winner-wallet').removeClass('animate__animated animate__pulse');
        }, 5000);

        // è‡ªåŠ¨æ»šåŠ¨åˆ°è·èƒœè€…é’±åŒ…
        const winnerWallet = $('.winner-wallet');
        if (winnerWallet.length > 0) {
            $('html, body').animate({
                scrollTop: winnerWallet.offset().top - 100
            }, 1000);
        }
    });
    {% endif %}
</script>

<!-- æ ·å¼å·²ç§»è‡³ static/css/style.css -->
{% endblock %}
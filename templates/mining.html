{% extends "base.html" %}

{% block title %}æŒ–çŸ¿ç«äº‰ - æ¯”ç‰¹å¸ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-hammer"></i> æŒ–çŸ¿ç«äº‰
        </h1>

        <!-- æŒ–çŸ¿è¯´æ˜æ¡† -->
        <div class="alert alert-info" role="alert">
            <h5 class="alert-heading">
                <i class="fas fa-info-circle"></i> æŒ–çŸ¿è¯´æ˜
            </h5>
            <p class="mb-2">
                <strong>æ³¨æ„ï¼šè¿™åªæ˜¯æ¨¡æ‹Ÿæ¼”ç¤ºï¼</strong>çœŸå®çš„æ¯”ç‰¹å¸æŒ–çŸ¿æƒ…å†µå¦‚ä¸‹ï¼š
            </p>
            <ul class="mb-2">
                <li><strong>å…¨çƒç«äº‰ï¼š</strong>æ¯”ç‰¹å¸ç½‘ç»œä¸­çš„æ‰€æœ‰çŸ¿å·¥ï¼ˆä¸–ç•Œå„åœ°çš„èŠ‚ç‚¹ï¼‰éƒ½åœ¨åŒæ—¶è®¡ç®—</li>
                <li><strong>å¹³å‡10åˆ†é’Ÿï¼š</strong>æ¯”ç‰¹å¸ç½‘ç»œè®¾è®¡ä¸ºå¹³å‡æ¯10åˆ†é’Ÿäº§å‡ºä¸€ä¸ªæ–°åŒºå—</li>
                <li><strong>è‡ªåŠ¨éš¾åº¦è°ƒæ•´ï¼š</strong>ç³»ç»Ÿä¼šæ ¹æ®å…¨ç½‘ç®—åŠ›è‡ªåŠ¨è°ƒæ•´æŒ–çŸ¿éš¾åº¦</li>
                <li><strong>åŒºå—æ‰“åŒ…æƒï¼š</strong>æŒ–çŸ¿èƒœåˆ©çš„çŸ¿å·¥è·å¾—åŒºå—æ‰“åŒ…æƒï¼Œå¯ä»¥é€‰æ‹©å“ªäº›äº¤æ˜“è¢«æ‰“åŒ…</li>
                <li><strong>äº¤æ˜“ç¡®è®¤ï¼š</strong>åªæœ‰åŒºå—è¢«æ‰“åŒ…åˆ°é“¾ä¸Šï¼Œäº¤æ˜“æ‰ç®—çœŸæ­£åˆ°è´¦</li>
                <li><strong>å¥–åŠ±æœºåˆ¶ï¼š</strong>è·èƒœçŸ¿å·¥å¯ä»¥è·å¾—å›ºå®šçš„åŒºå—å¥–åŠ±å’Œäº¤æ˜“æ‰‹ç»­è´¹</li>
            </ul>
            <p class="mb-0">
                <i class="fas fa-lightbulb text-warning"></i>
                <strong>æœ¬ç³»ç»Ÿä»…ä¸ºæ•™è‚²æ¼”ç¤ºï¼Œè®¡ç®—æ—¶é—´ä¸º10ç§’ï¼Œæ–¹ä¾¿è§‚å¯ŸæŒ–çŸ¿è¿‡ç¨‹</strong>
            </p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- æŒ–çŸ¿è½®æ¬¡æ§åˆ¶ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-play-circle"></i> æŒ–çŸ¿è½®æ¬¡æ§åˆ¶
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">å½“å‰è½®æ¬¡</label>
                            <div class="badge bg-primary fs-6" id="currentRound">ç¬¬ 1 è½®</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">è½®æ¬¡çŠ¶æ€</label>
                            <div class="badge bg-secondary fs-6" id="roundStatus">å‡†å¤‡å°±ç»ª</div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success btn-lg" id="startRoundBtn"
                        onclick="startMiningRound()">
                        <i class="fas fa-rocket"></i> å¼€å§‹æ–°ä¸€è½®æŒ–çŸ¿
                    </button>
                    <button type="button" class="btn btn-warning btn-lg" id="packageBtn" onclick="packageBlock()"
                        style="display: none;">
                        <i class="fas fa-cube"></i> æ‰“åŒ…åŒºå—
                    </button>
                </div>
            </div>
        </div>

        <!-- çŸ¿å·¥çŠ¶æ€é¢æ¿ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users"></i> çŸ¿å·¥çŠ¶æ€
                    <span class="badge bg-info ms-2" id="participantCount">0 ä¸ªå‚ä¸è€…</span>
                </h5>
            </div>
            <div class="card-body">
                <div id="minersGrid" class="row">
                    <!-- çŸ¿å·¥å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- æŒ–çŸ¿ç»Ÿè®¡ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar"></i> æŒ–çŸ¿ç»Ÿè®¡
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">åŒºå—å¥–åŠ±:</small><br>
                    <span class="badge bg-warning fs-6">50.0000 BTC</span>
                </div>
                <div class="mb-3">
                    <small class="text-muted">å½“å‰éš¾åº¦:</small><br>
                    <span id="currentDifficulty" class="badge bg-info fs-6">{{ chain_info.difficulty if chain_info else
                        'N/A' }}</span>
                </div>
                <div class="mb-3">
                    <small class="text-muted">æœ€æ–°åŒºå—:</small><br>
                    <span id="latestBlock" class="badge bg-primary fs-6">#{{ chain_info.height if chain_info else 0
                        }}</span>
                </div>
                <div class="mb-3">
                    <small class="text-muted">å¾…å¤„ç†äº¤æ˜“:</small><br>
                    <span id="pendingTx" class="badge bg-warning fs-6">{{ pending_transactions }}</span>
                </div>
                <div class="mb-3">
                    <small class="text-muted">è®¡ç®—æ—¶é—´:</small><br>
                    <span class="badge bg-success fs-6">10 ç§’</span>
                </div>
            </div>
        </div>

        <!-- è·èƒœè€…ä¿¡æ¯ -->
        <div class="card mb-4" id="winnerCard" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-trophy"></i> æœ¬è½®è·èƒœè€…
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div class="mb-2">
                        <i class="fas fa-crown text-warning fs-1"></i>
                    </div>
                    <h4 id="winnerName" class="text-success">-</h4>
                    <p class="text-muted small" id="winnerAddress">-</p>
                    <div class="mt-3">
                        <small class="text-muted">è·èƒœ Nonce:</small><br>
                        <span id="winnerNonce" class="badge bg-success">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŒ–çŸ¿æ—¥å¿— -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-terminal"></i> æŒ–çŸ¿æ—¥å¿—
                </h5>
            </div>
            <div class="card-body">
                <div id="miningLog" class="bg-dark text-light p-3 rounded" style="height: 300px; overflow-y: auto;">
                    <div class="text-muted">æŒ–çŸ¿æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ ·å¼å·²ç§»è‡³ static/css/style.css -->

<script>
    let roundUpdateInterval;
    let currentRoundData = null;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        updateStats();
        initializeMiningRound();

        // å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        setInterval(updateStats, 5000);
    });

    function initializeMiningRound() {
        // è·å–å½“å‰åŒºå—é«˜åº¦å¹¶æ›´æ–°è½®æ¬¡æ˜¾ç¤º
        $.get('/api/blockchain_stats', function (data) {
            if (data.height !== undefined) {
                const nextRound = data.height + 1;
                document.getElementById('currentRound').textContent = `ç¬¬ ${nextRound} è½®`;
            }
        });

        // åˆå§‹åŒ–çŸ¿å·¥é¢æ¿
        $.get('/api/wallets', function (data) {
            if (data.wallets) {
                displayMiners(data.wallets);
            }
        });

        addToLog('ğŸ”§ æŒ–çŸ¿ç³»ç»Ÿå·²åˆå§‹åŒ–');
    }

    function displayMiners(wallets) {
        const minersGrid = document.getElementById('minersGrid');
        minersGrid.innerHTML = '';

        wallets.forEach(wallet => {
            const minerCard = createMinerCard(wallet);
            minersGrid.appendChild(minerCard);
        });

        document.getElementById('participantCount').textContent = `${wallets.length} ä¸ªå‚ä¸è€…`;
    }

    function createMinerCard(wallet) {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';

        col.innerHTML = `
        <div class="miner-card idle" id="miner-${wallet.name}">
            <div class="d-flex align-items-center mb-2">
                <div class="me-3">
                    <i class="fas fa-user-circle fs-4 text-primary"></i>
                </div>
                <div>
                    <h6 class="mb-1">${wallet.name}</h6>
                    <small class="text-muted">${wallet.address.substring(0, 16)}...</small>
                </div>
            </div>
            
            <div class="row">
                <div class="col-6">
                    <small class="text-muted">Nonce:</small><br>
                    <span class="nonce-counter" id="nonce-${wallet.name}">0</span>
                </div>
                <div class="col-6">
                    <small class="text-muted">çŠ¶æ€:</small><br>
                    <span class="badge bg-secondary" id="status-${wallet.name}">ç­‰å¾…</span>
                </div>
            </div>
            
            <div class="mining-progress">
                <div class="mining-progress-bar" id="progress-${wallet.name}" style="width: 0%"></div>
            </div>
        </div>
    `;

        return col;
    }

    function startMiningRound() {
        const startBtn = document.getElementById('startRoundBtn');
        startBtn.disabled = true;

        $.ajax({
            url: '/api/start_mining_round',
            method: 'POST',
            contentType: 'application/json',
            success: function (response) {
                if (response.success) {
                    addToLog(`ğŸš€ å¼€å§‹ç¬¬ ${response.round_number + 1} è½®æŒ–çŸ¿ç«äº‰`);
                    addToLog(`ğŸ‘¥ å‚ä¸è€…: ${response.participants.map(p => p.name).join(', ')}`);

                    // æ›´æ–°UIçŠ¶æ€
                    document.getElementById('roundStatus').textContent = 'è®¡ç®—ä¸­...';
                    document.getElementById('roundStatus').className = 'badge bg-warning fs-6';

                    // éšè—è·èƒœè€…å¡ç‰‡
                    document.getElementById('winnerCard').style.display = 'none';

                    // å¼€å§‹è½®æ¬¡çŠ¶æ€æ›´æ–°
                    startRoundUpdates();

                    // å¯åŠ¨æ‰€æœ‰çŸ¿å·¥çš„åŠ¨ç”»
                    response.participants.forEach(participant => {
                        const minerCard = document.getElementById(`miner-${participant.name}`);
                        const statusBadge = document.getElementById(`status-${participant.name}`);

                        if (minerCard && statusBadge) {
                            minerCard.className = 'miner-card computing';
                            statusBadge.textContent = 'è®¡ç®—ä¸­';
                            statusBadge.className = 'badge bg-warning';
                        }
                    });

                } else {
                    addToLog(`âŒ å¼€å§‹æŒ–çŸ¿å¤±è´¥: ${response.error}`);
                    if (response.error.includes('æŒ–çŸ¿è½®æ¬¡å·²åœ¨è¿›è¡Œä¸­')) {
                        addToLog(`ğŸ’¡ æç¤º: å¦‚æœç¡®è®¤æ²¡æœ‰æŒ–çŸ¿åœ¨è¿›è¡Œï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•`);
                    }
                    startBtn.disabled = false;
                }
            },
            error: function (xhr) {
                const response = xhr.responseJSON;
                const errorMsg = response ? response.error : 'æœªçŸ¥é”™è¯¯';
                addToLog(`âŒ å¼€å§‹æŒ–çŸ¿å¤±è´¥: ${errorMsg}`);
                if (errorMsg.includes('æŒ–çŸ¿è½®æ¬¡å·²åœ¨è¿›è¡Œä¸­')) {
                    addToLog(`ğŸ’¡ æç¤º: å¦‚æœç¡®è®¤æ²¡æœ‰æŒ–çŸ¿åœ¨è¿›è¡Œï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•`);
                }
                startBtn.disabled = false;
            }
        });
    }

    function startRoundUpdates() {
        if (roundUpdateInterval) {
            clearInterval(roundUpdateInterval);
        }

        roundUpdateInterval = setInterval(function () {
            updateRoundStatus();
        }, 500); // æ¯0.5ç§’æ›´æ–°ä¸€æ¬¡
    }

    function updateRoundStatus() {
        $.get('/api/mining_round_status', function (data) {
            if (data.success) {
                currentRoundData = data;

                if (!data.round_active) {
                    stopRoundUpdates();
                    return;
                }

                // æ›´æ–°å‚ä¸è€…çŠ¶æ€
                if (data.participants) {
                    data.participants.forEach(participant => {
                        const nonceElement = document.getElementById(`nonce-${participant.name}`);
                        const progressElement = document.getElementById(`progress-${participant.name}`);

                        if (nonceElement) {
                            nonceElement.textContent = participant.nonce.toLocaleString();
                        }

                        if (progressElement && data.computing_time > 0) {
                            const progress = Math.min(100, (data.elapsed_time / data.computing_time) * 100);
                            progressElement.style.width = progress + '%';
                        }
                    });
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰è·èƒœè€…
                if (data.winner && data.block_ready) {
                    showWinner(data.winner);
                    stopRoundUpdates();

                    // æ˜¾ç¤ºæ‰“åŒ…æŒ‰é’®
                    document.getElementById('packageBtn').style.display = 'block';
                    document.getElementById('roundStatus').textContent = 'å‡†å¤‡æ‰“åŒ…';
                    document.getElementById('roundStatus').className = 'badge bg-success fs-6';
                }
            }
        });
    }

    function showWinner(winner) {
        addToLog(`ğŸ¯ è·èƒœè€…: ${winner.name}`);

        // æ›´æ–°è·èƒœè€…å¡ç‰‡
        document.getElementById('winnerName').textContent = winner.name;
        document.getElementById('winnerAddress').textContent = winner.address;
        document.getElementById('winnerNonce').textContent = winner.nonce.toLocaleString();
        document.getElementById('winnerCard').style.display = 'block';

        // æ›´æ–°çŸ¿å·¥çŠ¶æ€
        currentRoundData.participants.forEach(participant => {
            const minerCard = document.getElementById(`miner-${participant.name}`);
            const statusBadge = document.getElementById(`status-${participant.name}`);

            if (minerCard && statusBadge) {
                if (participant.name === winner.name) {
                    minerCard.className = 'miner-card winner';
                    statusBadge.textContent = 'è·èƒœ';
                    statusBadge.className = 'badge bg-success';
                } else {
                    minerCard.className = 'miner-card idle';
                    statusBadge.textContent = 'å¤±è´¥';
                    statusBadge.className = 'badge bg-danger';
                }
            }
        });
    }

    function packageBlock() {
        const packageBtn = document.getElementById('packageBtn');
        packageBtn.disabled = true;

        $.ajax({
            url: '/api/package_block',
            method: 'POST',
            contentType: 'application/json',
            success: function (response) {
                if (response.success) {
                    addToLog(`ğŸ‰ åŒºå—æ‰“åŒ…æˆåŠŸ!`);
                    addToLog(`ğŸ“¦ åŒºå— #${response.block_index} å·²ç”Ÿæˆ`);
                    addToLog(`ğŸ† è·èƒœè€…: ${response.winner}`);
                    addToLog(`ğŸ’° å¥–åŠ±: ${response.reward} BTC + ${response.transaction_fee} BTC äº¤æ˜“è´¹`);
                    addToLog(`ğŸ“Š åŒ…å« ${response.transaction_count} ç¬”äº¤æ˜“`);
                    addToLog(`ğŸ”„ æ­£åœ¨é‡ç½®çŠ¶æ€å¹¶è·³è½¬åˆ°é’±åŒ…é¡µé¢...`);

                    // è‡ªåŠ¨é‡ç½®æŒ–çŸ¿çŠ¶æ€
                    $.ajax({
                        url: '/api/reset_mining_round',
                        method: 'POST',
                        contentType: 'application/json',
                        success: function (resetResponse) {
                            if (resetResponse.success) {
                                // è·³è½¬åˆ°é’±åŒ…ç®¡ç†é¡µé¢ï¼Œæ˜¾ç¤ºæ›´æ–°åçš„ä½™é¢
                                window.location.href = '/wallets?highlight=' + encodeURIComponent(response.winner);
                            } else {
                                // å³ä½¿é‡ç½®å¤±è´¥ä¹Ÿè·³è½¬
                                window.location.href = '/wallets?highlight=' + encodeURIComponent(response.winner);
                            }
                        },
                        error: function () {
                            // å³ä½¿é‡ç½®å¤±è´¥ä¹Ÿè·³è½¬
                            window.location.href = '/wallets?highlight=' + encodeURIComponent(response.winner);
                        }
                    });

                } else {
                    addToLog(`âŒ åŒºå—æ‰“åŒ…å¤±è´¥: ${response.error}`);
                    packageBtn.disabled = false;
                }
            },
            error: function (xhr) {
                const response = xhr.responseJSON;
                addToLog(`âŒ åŒºå—æ‰“åŒ…å¤±è´¥: ${response ? response.error : 'æœªçŸ¥é”™è¯¯'}`);
                packageBtn.disabled = false;
            }
        });
    }

    function resetMiningRound() {
        if (!confirm('ç¡®å®šè¦é‡ç½®æŒ–çŸ¿è½®æ¬¡çŠ¶æ€å—ï¼Ÿè¿™å°†æ¸…é™¤å½“å‰çš„æŒ–çŸ¿è¿›åº¦ã€‚')) {
            return;
        }

        $.ajax({
            url: '/api/reset_mining_round',
            method: 'POST',
            contentType: 'application/json',
            success: function (response) {
                if (response.success) {
                    addToLog(`ğŸ”„ ${response.message}`);

                    // é‡ç½®UIçŠ¶æ€
                    resetRoundUI();

                    // åœæ­¢æ‰€æœ‰æ›´æ–°
                    stopRoundUpdates();

                    // é‡æ–°åˆå§‹åŒ–çŸ¿å·¥é¢æ¿
                    initializeMiningRound();

                } else {
                    addToLog(`âŒ é‡ç½®å¤±è´¥: ${response.error}`);
                }
            },
            error: function (xhr) {
                const response = xhr.responseJSON;
                addToLog(`âŒ é‡ç½®å¤±è´¥: ${response ? response.error : 'æœªçŸ¥é”™è¯¯'}`);
            }
        });
    }

    function resetRoundUI() {
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        document.getElementById('startRoundBtn').disabled = false;
        document.getElementById('packageBtn').style.display = 'none';

        // é‡ç½®çŠ¶æ€æ˜¾ç¤º
        document.getElementById('roundStatus').textContent = 'å‡†å¤‡å°±ç»ª';
        document.getElementById('roundStatus').className = 'badge bg-secondary fs-6';

        // é‡ç½®æ‰€æœ‰çŸ¿å·¥å¡ç‰‡
        const minerCards = document.querySelectorAll('.miner-card');
        minerCards.forEach(card => {
            card.className = 'miner-card idle';
        });

        // é‡ç½®æ‰€æœ‰çŠ¶æ€æ˜¾ç¤º
        const statusBadges = document.querySelectorAll('[id^="status-"]');
        statusBadges.forEach(badge => {
            badge.textContent = 'ç­‰å¾…';
            badge.className = 'badge bg-secondary';
        });

        // é‡ç½®è¿›åº¦æ¡
        const progressBars = document.querySelectorAll('[id^="progress-"]');
        progressBars.forEach(bar => {
            bar.style.width = '0%';
        });

        // é‡ç½®nonceæ˜¾ç¤º
        const nonces = document.querySelectorAll('[id^="nonce-"]');
        nonces.forEach(nonce => {
            nonce.textContent = '0';
        });
    }

    function stopRoundUpdates() {
        if (roundUpdateInterval) {
            clearInterval(roundUpdateInterval);
        }
    }

    function updateStats() {
        $.get('/api/blockchain_stats', function (data) {
            if (data.height !== undefined) {
                document.getElementById('latestBlock').textContent = '#' + data.height;
                document.getElementById('currentDifficulty').textContent = data.difficulty;
                document.getElementById('pendingTx').textContent = data.pending_transactions;

                // æ›´æ–°å½“å‰è½®æ¬¡æ˜¾ç¤ºï¼ˆä¸‹ä¸€ä¸ªè¦æŒ–çš„åŒºå—ï¼‰
                const nextRound = data.height + 1;
                document.getElementById('currentRound').textContent = `ç¬¬ ${nextRound} è½®`;
            }
        });
    }

    function addToLog(message) {
        const logElement = document.getElementById('miningLog');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
        logElement.appendChild(logEntry);

        // ä¿æŒæ—¥å¿—æ•°é‡ä¸è¶…è¿‡100æ¡
        while (logElement.children.length > 100) {
            logElement.removeChild(logElement.firstChild);
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        logElement.scrollTop = logElement.scrollHeight;
    }

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', function () {
        stopRoundUpdates();
    });
</script>
{% endblock %}